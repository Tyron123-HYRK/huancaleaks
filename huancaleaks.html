<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuancaLeaks - Lo que pasa en la Incontrastable</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-orange': '#ff7b00',
                        'brand-dark': '#0f0f0f',
                        'brand-gray': '#1a1a1a',
                        'brand-light': '#e5e5e5',
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f0f0f;
            color: #e5e5e5;
            background-image: radial-gradient(#ff7b0015 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .glass-panel {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 123, 0, 0.1);
        }
        .scroll-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_URL = 'http://localhost:3000/api';
        const initialPosts = [];

        const ZONES = ["Todos", "El Tambo", "Huancayo Centro", "Chilca", "Pilcomayo", "Sapallanga", "San Carlos"];
        const CAREERS = ["Todas", "Ingeniería Civil - UNCP", "Medicina - UNCP", "Derecho - UPLA", "Contabilidad - UPLA", "Medicina - Continental", "Arquitectura - Continental", "Otros"];

        // --- COMPONENTES ---

        const Header = ({ onOpenModal }) => (
            <header className="sticky top-0 z-50 glass-panel border-b border-gray-800 shadow-lg shadow-orange-500/10">
                <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <i className="fas fa-fire text-brand-orange text-2xl animate-pulse"></i>
                        <h1 className="text-2xl font-extrabold tracking-tighter">
                            HUANCA<span className="text-brand-orange">LEAKS</span>
                        </h1>
                    </div>
                    <button 
                        onClick={onOpenModal}
                        className="bg-brand-orange hover:bg-orange-600 text-black font-bold py-2 px-4 rounded-full transition-all transform hover:scale-105 flex items-center gap-2 text-sm sm:text-base">
                        <i className="fas fa-camera"></i>
                        <span className="hidden sm:inline">Exponer Infiel</span>
                    </button>
                </div>
            </header>
        );

        const ReportCard = ({ report }) => (
            <div className="glass-panel rounded-xl overflow-hidden mb-6 hover:shadow-orange-500/20 transition-all duration-300">
                <div className="p-4 flex items-center gap-3 border-b border-gray-800">
                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                        <i className="fas fa-user-secret text-brand-orange"></i>
                    </div>
                    <div>
                        <p className="font-bold text-sm text-white">{report.targetName} <span className="text-xs font-normal text-gray-400">(Reportado por: {report.name})</span></p>
                        <p className="text-xs text-brand-orange">{report.profession}</p>
                    </div>
                    <div className="ml-auto text-xs text-gray-500">
                        {report.date}
                    </div>
                </div>
                
                {report.image && (
                    <div className="w-full h-64 sm:h-80 bg-gray-900 relative overflow-hidden group">
                        <img src={report.image} alt="Evidencia" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                        <div className="absolute bottom-0 left-0 bg-black/70 text-white text-xs px-2 py-1 m-2 rounded">
                            <i className="fas fa-map-marker-alt mr-1 text-brand-orange"></i> {report.location}
                        </div>
                    </div>
                )}

                <div className="p-4">
                    <p className="text-gray-300 text-sm mb-4 leading-relaxed">
                        {report.description}
                    </p>
                    
                    <div className="flex items-center justify-between border-t border-gray-800 pt-3">
                        <div className="flex gap-4 text-gray-400 text-sm">
                            <button className="hover:text-brand-orange flex items-center gap-1 transition-colors">
                                <i className="fas fa-fire-alt"></i> {report.likes} Quemados
                            </button>
                            <button className="hover:text-brand-orange flex items-center gap-1 transition-colors">
                                <i className="far fa-comment"></i> Comentar
                            </button>
                        </div>
                        <button className="text-gray-500 hover:text-white">
                            <i className="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        );

        const Sidebar = ({ selectedZone, setSelectedZone, selectedUni, setSelectedUni, searchTerm, setSearchTerm }) => (
            <div className="space-y-6 sticky top-24">
                {/* Top Vistos */}
                <div className="glass-panel p-5 rounded-xl">
                    <h3 className="font-bold text-brand-orange mb-4 flex items-center gap-2">
                        <i className="fas fa-chart-line"></i> Tendencias Huancayo
                    </h3>
                    <ul className="space-y-3 text-sm text-gray-300">
                        <li className="flex justify-between cursor-pointer hover:text-white">
                            <span>#RealPlaza</span>
                            <span className="text-gray-500">1.2k</span>
                        </li>
                        <li className="flex justify-between cursor-pointer hover:text-white">
                            <span>#UNCP_Civil</span>
                            <span className="text-gray-500">856</span>
                        </li>
                        <li className="flex justify-between cursor-pointer hover:text-white">
                            <span>#CerritoDeLaLibertad</span>
                            <span className="text-gray-500">540</span>
                        </li>
                    </ul>
                </div>

                {/* Filtros */}
                <div className="glass-panel p-5 rounded-xl">
                    <h3 className="font-bold text-white mb-4">Filtrar Chisme</h3>
                    
                    <div className="mb-4">
                        <input 
                            type="text" 
                            placeholder="Buscar nombre..." 
                            className="w-full bg-brand-dark border border-gray-700 rounded-lg p-2 text-sm text-white focus:border-brand-orange outline-none"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    <div className="mb-4">
                        <label className="text-xs text-gray-500 uppercase font-bold mb-2 block">Por Zona</label>
                        <div className="flex flex-wrap gap-2">
                            {ZONES.map(zone => (
                                <button 
                                    key={zone}
                                    onClick={() => setSelectedZone(zone)}
                                    className={`text-xs px-3 py-1 rounded-full border ${selectedZone === zone ? 'bg-brand-orange border-brand-orange text-black' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}
                                >
                                    {zone}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div>
                        <label className="text-xs text-gray-500 uppercase font-bold mb-2 block">Por Carrera/Lugar</label>
                        <select 
                            className="w-full bg-brand-dark border border-gray-700 rounded-lg p-2 text-sm text-gray-300 outline-none focus:border-brand-orange"
                            value={selectedUni}
                            onChange={(e) => setSelectedUni(e.target.value)}
                        >
                            {CAREERS.map(career => (
                                <option key={career} value={career}>{career}</option>
                            ))}
                        </select>
                    </div>
                </div>

                <div className="text-xs text-center text-gray-600">
                    <p>© 2025 HuancaLeaks.</p>
                    <p>Entretenimiento satírico.</p>
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, onSubmit }) => {
            const [preview, setPreview] = useState(null);

            useEffect(() => {
                if (!isOpen) setPreview(null);
            }, [isOpen]);

            if (!isOpen) return null;

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const objectUrl = URL.createObjectURL(file);
                    setPreview(objectUrl);
                } else {
                    setPreview(null);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                onSubmit(formData);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="glass-panel w-full max-w-lg rounded-xl overflow-hidden animate-fade-in-up max-h-[90vh] overflow-y-auto">
                        <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-white">Nuevo Reporte</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4" encType="multipart/form-data">
                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">Nombre del "Susodicho/a" (Opcional)</label>
                                <input name="targetName" type="text" placeholder="Ej. Juan Perez" className="w-full bg-brand-dark border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none" />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-400 mb-1">Carrera / Universidad</label>
                                    <input name="profession" type="text" placeholder="Ej. Ing. Civil - UNCP" className="w-full bg-brand-dark border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-400 mb-1">Zona / Lugar</label>
                                    <input name="location" type="text" placeholder="Ej. Real Plaza" className="w-full bg-brand-dark border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none" required />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">El Chisme (Descripción)</label>
                                <textarea name="description" required rows="4" placeholder="Cuenta todo con lujo de detalles..." className="w-full bg-brand-dark border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none"></textarea>
                            </div>

                            <div className="border-2 border-dashed border-gray-700 rounded-lg p-6 text-center hover:border-brand-orange transition-colors relative overflow-hidden group">
                                <input type="file" name="image" onChange={handleFileChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*" />
                                
                                {preview ? (
                                    <div className="relative h-48 w-full">
                                        <img src={preview} alt="Previsualización" className="w-full h-full object-cover rounded" />
                                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            <p className="text-white font-bold"><i className="fas fa-sync-alt mr-2"></i>Cambiar Foto</p>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <i className="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-2"></i>
                                        <p className="text-sm text-gray-400">Sube tu evidencia (Foto)</p>
                                        <p className="text-xs text-gray-600 mt-1">Click para seleccionar archivo</p>
                                    </>
                                )}
                            </div>

                            <div className="bg-orange-900/20 p-3 rounded border border-orange-500/20 text-xs text-orange-200">
                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                <strong>Disclaimer:</strong> Este reporte es anónimo. Tú eres responsable de la veracidad de la información.
                            </div>

                            <button type="submit" className="w-full bg-brand-orange text-black font-bold py-3 rounded hover:bg-orange-600 transition-colors">
                                PUBLICAR ANÓNIMAMENTE
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const DisclaimerBanner = ({ onClose }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-brand-orange text-black p-4 z-50 flex justify-between items-center flex-wrap gap-4 shadow-lg border-t-4 border-black">
                <div className="text-sm font-semibold max-w-4xl">
                    <i className="fas fa-balance-scale mr-2"></i>
                    ADVERTENCIA LEGAL: Esta página es exclusivamente para fines de entretenimiento y sátira social. 
                    "HuancaLeaks" no verifica la veracidad de los reportes enviados por usuarios anónimos y no se hace responsable por daños a la reputación.
                </div>
                <button onClick={onClose} className="bg-black text-white px-4 py-2 rounded text-sm hover:bg-gray-800 font-bold">
                    ENTENDIDO, QUIERO VER EL CHISME
                </button>
            </div>
        );

        // --- APP PRINCIPAL ---

        const App = () => {
            const [posts, setPosts] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showDisclaimer, setShowDisclaimer] = useState(true);
            const [loading, setLoading] = useState(true);
            
            // Estados de Filtro
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedZone, setSelectedZone] = useState("Todos");
            const [selectedUni, setSelectedUni] = useState("Todas");

            useEffect(() => {
                fetchPosts();
            }, []);

            const fetchPosts = async () => {
                try {
                    const response = await fetch(`${API_URL}/posts`);
                    const data = await response.json();
                    
                    const mappedPosts = data.map(p => ({
                        id: p.id,
                        name: p.name,
                        targetName: p.target_name,
                        profession: p.profession,
                        location: p.location,
                        description: p.description,
                        date: new Date(p.date).toLocaleString(),
                        likes: p.likes,
                        image: p.image_url ? (p.image_url.startsWith('http') ? p.image_url : `http://localhost:3000${p.image_url}`) : null
                    }));
                    setPosts(mappedPosts);
                    setLoading(false);
                } catch (error) {
                    console.error("Error fetching posts:", error);
                    setLoading(false);
                }
            };

            const handleNewPost = async (formData) => {
                try {
                    const response = await fetch(`${API_URL}/posts`, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.ok) {
                        fetchPosts(); 
                        setIsModalOpen(false);
                    } else {
                        alert("Error al publicar");
                    }
                } catch (error) {
                    console.error("Error posting:", error);
                }
            };

            // Lógica de Filtrado
            const filteredPosts = posts.filter(post => {
                const matchesSearch = (post.targetName || "").toLowerCase().includes(searchTerm.toLowerCase()) || 
                                      (post.description || "").toLowerCase().includes(searchTerm.toLowerCase());
                const matchesZone = selectedZone === "Todos" || (post.location || "").includes(selectedZone);
                const matchesUni = selectedUni === "Todas" || post.profession === selectedUni;

                return matchesSearch && matchesZone && matchesUni;
            });

            return (
                <div className="min-h-screen pb-10">
                    <Header onOpenModal={() => setIsModalOpen(true)} />

                    <main className="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        {/* Columna Izquierda (Feed) */}
                        <div className="lg:col-span-2">
                            <div className="mb-6 flex items-center justify-between">
                                <h2 className="text-xl font-bold text-white border-l-4 border-brand-orange pl-3">Últimos Reportes</h2>
                                <span className="text-sm text-gray-500">{filteredPosts.length} resultados</span>
                            </div>

                            {loading ? (
                                <div className="text-center py-8">
                                    <div className="inline-block w-8 h-8 border-4 border-brand-orange border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : filteredPosts.length > 0 ? (
                                filteredPosts.map(post => (
                                    <ReportCard key={post.id} report={post} />
                                ))
                            ) : (
                                <div className="text-center py-20 glass-panel rounded-xl">
                                    <i className="fas fa-search text-4xl text-gray-600 mb-4"></i>
                                    <p className="text-gray-400">No se encontraron reportes con esos filtros.</p>
                                    <p className="text-brand-orange text-sm cursor-pointer" onClick={() => {setSelectedZone("Todos"); setSelectedUni("Todas"); setSearchTerm("");}}>Limpiar filtros</p>
                                </div>
                            )}
                            
                            {!loading && filteredPosts.length > 0 && (
                                <div className="text-center py-8 text-gray-500 text-xs">
                                    No hay más publicaciones
                                </div>
                            )}
                        </div>

                        {/* Columna Derecha (Sidebar) */}
                        <div className="hidden lg:block">
                            <Sidebar 
                                selectedZone={selectedZone} 
                                setSelectedZone={setSelectedZone}
                                selectedUni={selectedUni}
                                setSelectedUni={setSelectedUni}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                            />
                        </div>
                    </main>

                    {/* Botón flotante para móviles (Filtros) */}
                    <div className="lg:hidden fixed bottom-6 right-6 z-40">
                        <button className="bg-brand-gray border border-brand-orange text-brand-orange p-4 rounded-full shadow-lg shadow-black">
                            <i className="fas fa-filter"></i>
                        </button>
                    </div>

                    <Modal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSubmit={handleNewPost} 
                    />

                    {showDisclaimer && <DisclaimerBanner onClose={() => setShowDisclaimer(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>