<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Version: 2.0.0 - Professional Edition -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuancaLeaks - Lo que pasa en la Incontrastable</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-orange': '#ff7b00',
                        'brand-dark': '#0f0f0f',
                        'brand-gray': '#1a1a1a',
                        'brand-light': '#e5e5e5',
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f0f0f;
            color: #e5e5e5;
            background-image: radial-gradient(#ff7b0015 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .glass-panel {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 123, 0, 0.1);
        }
        .scroll-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_URL = '/api';

        // --- DATOS MAESTROS DE HUANCAYO ---
        const HUANCAYO_DATA = {
            "UNCP (Nacional del Centro)": [
                "Ingeniería Civil", "Ingeniería de Minas", "Ingeniería de Sistemas", "Medicina Humana", 
                "Enfermería", "Arquitectura", "Administración", "Contabilidad", "Economía", 
                "Antropología", "Educación", "Trabajo Social", "Ingeniería Química", "Ingeniería Metalúrgica"
            ],
            "UPLA (Los Andes)": [
                "Derecho", "Medicina Humana", "Odontología", "Psicología", "Ingeniería Civil", 
                "Ingeniería Industrial", "Arquitectura", "Farmacia y Bioquímica", "Veterinaria", "Tecnología Médica"
            ],
            "Universidad Continental": [
                "Medicina Humana", "Derecho", "Psicología", "Ingeniería Civil", "Ingeniería Ambiental", 
                "Ingeniería Industrial", "Ingeniería Mecatrónica", "Administración", "Contabilidad", "Ciencias de la Comunicación"
            ],
            "Universidad Roosevelt": [
                "Ciencias Farmacéuticas", "Enfermería", "Obstetricia", "Estomatología", "Administración y Negocios"
            ],
            "UNJSA (Juan Santos Atahualpa)": [
                "Ingeniería Civil", "Ingeniería Ambiental", "Administración", "Educación Intercultural"
            ],
            "Institutos / Otros": [
                "Senati", "Sencico", "Continental (Instituto)", "Santiago Antúnez de Mayolo", "San Pedro"
            ],
            "Lugares Públicos / Otros": [
                "Real Plaza", "Open Plaza", "Parque Constitución", "Parque Huamanmarca", "Cerrito de la Libertad", "Torre Torre", "Discotecas / Bares", "Gimnasios"
            ]
        };

        const ZONES = ["Todos", "El Tambo", "Huancayo Centro", "Chilca", "Pilcomayo", "Sapallanga", "San Carlos", "San Jerónimo", "Cajas", "Azapampa"];

        // --- COMPONENTES ---

        const Header = ({ onOpenModal }) => (
            <header className="sticky top-0 z-50 glass-panel border-b border-gray-800 shadow-lg shadow-orange-500/10">
                <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => window.location.reload()}>
                        <i className="fas fa-fire text-brand-orange text-2xl animate-pulse"></i>
                        <h1 className="text-2xl font-extrabold tracking-tighter">
                            HUANCA<span className="text-brand-orange">LEAKS</span>
                        </h1>
                    </div>
                    <div className="flex items-center gap-4">
                        <a href="/directory.html" className="hidden sm:flex text-sm font-bold text-gray-400 hover:text-brand-orange transition-colors items-center gap-2">
                            <i className="fas fa-list"></i> Directorio
                        </a>
                        <button 
                            onClick={onOpenModal}
                            className="bg-brand-orange hover:bg-orange-600 text-black font-bold py-2 px-4 rounded-full transition-all transform hover:scale-105 flex items-center gap-2 text-sm sm:text-base shadow-[0_0_15px_rgba(255,123,0,0.5)]">
                            <i className="fas fa-camera"></i>
                            <span className="hidden sm:inline">Exponer Infiel</span>
                        </button>
                    </div>
                </div>
            </header>
        );

        const ReportCard = ({ report }) => (
            <div className="glass-panel rounded-xl overflow-hidden mb-6 hover:border-orange-500/50 transition-all duration-300 animate-fade-in">
                <div className="p-4 flex items-center gap-3 border-b border-gray-800 bg-gradient-to-r from-gray-900 to-transparent">
                    <div className="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700">
                        <i className="fas fa-user-secret text-brand-orange text-lg"></i>
                    </div>
                    <div>
                        <p className="font-bold text-sm text-white flex items-center gap-2">
                            {report.targetName} 
                        </p>
                        <p className="text-xs text-brand-orange font-semibold tracking-wide">{report.profession}</p>
                    </div>
                    <div className="ml-auto text-xs text-gray-500 flex flex-col items-end">
                        <span>{report.date}</span>
                        <span className="text-gray-600 text-[10px]">ID: #{report.id}</span>
                    </div>
                </div>
                
                {report.image && (
                    <div className="w-full h-64 sm:h-96 bg-gray-900 relative overflow-hidden group">
                        <img src={report.image} alt="Evidencia" className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                        <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/90 to-transparent p-4 pt-10">
                            <div className="inline-flex items-center gap-2 bg-brand-orange/20 backdrop-blur-md border border-brand-orange/30 px-3 py-1 rounded-full text-xs text-brand-orange font-bold">
                                <i className="fas fa-map-marker-alt"></i> {report.location}
                            </div>
                        </div>
                    </div>
                )}

                <div className="p-5">
                    <p className="text-gray-300 text-sm leading-relaxed whitespace-pre-line font-medium">
                        {report.description}
                    </p>
                </div>
            </div>
        );

        const Sidebar = ({ selectedZone, setSelectedZone, selectedUni, setSelectedUni, selectedCareer, setSelectedCareer, searchTerm, setSearchTerm }) => {
            const [trends, setTrends] = useState({ locations: [], professions: [] });
            const [loadingTrends, setLoadingTrends] = useState(true);

            useEffect(() => {
                const fetchTrends = async () => {
                    try {
                        const res = await fetch(`${API_URL}/posts/trends`);
                        if (res.ok) {
                            const data = await res.json();
                            setTrends(data);
                        }
                    } catch (e) {
                        console.error("Error loading trends", e);
                    } finally {
                        setLoadingTrends(false);
                    }
                };
                fetchTrends();
            }, []);

            const careersForSelectedUni = useMemo(() => {
                if (selectedUni === "Todas" || !HUANCAYO_DATA[selectedUni]) return [];
                return HUANCAYO_DATA[selectedUni];
            }, [selectedUni]);

            return (
                <div className="space-y-6 sticky top-24">
                    {/* Top Tendencias */}
                    <div className="glass-panel p-5 rounded-xl border-l-4 border-brand-orange">
                        <h3 className="font-bold text-brand-orange mb-4 flex items-center gap-2 uppercase tracking-wider text-sm">
                            <i className="fas fa-chart-pie"></i> Tendencias Reales
                        </h3>
                        
                        {loadingTrends ? (
                            <p className="text-xs text-gray-500 animate-pulse">Cargando datos en vivo...</p>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Lugares + Calientes</h4>
                                    <ul className="space-y-2">
                                        {trends.locations.length > 0 ? trends.locations.map((loc, i) => (
                                            <li key={i} className="flex justify-between text-sm group cursor-default">
                                                <span className="text-gray-300 group-hover:text-white transition-colors truncate max-w-[70%]">#{loc.name}</span>
                                                <span className="text-brand-orange font-mono text-xs">{loc.count} posts</span>
                                            </li>
                                        )) : <li className="text-xs text-gray-600 italic">Sin datos aún</li>}
                                    </ul>
                                </div>
                                <div className="border-t border-gray-800 pt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Carreras + Quemadas</h4>
                                    <ul className="space-y-2">
                                        {trends.professions.length > 0 ? trends.professions.map((prof, i) => (
                                            <li key={i} className="flex justify-between text-sm group cursor-default">
                                                <span className="text-gray-300 group-hover:text-white transition-colors truncate max-w-[70%]">{prof.name}</span>
                                                <span className="text-brand-orange font-mono text-xs">{prof.count}</span>
                                            </li>
                                        )) : <li className="text-xs text-gray-600 italic">Sin datos aún</li>}
                                    </ul>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Filtros Profesionales */}
                    <div className="glass-panel p-5 rounded-xl">
                        <h3 className="font-bold text-white mb-4 text-sm uppercase tracking-wider">Filtrar Base de Datos</h3>
                        
                        <div className="space-y-4">
                            <div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar por nombre, apodo..." 
                                    className="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-sm text-white focus:border-brand-orange outline-none transition-colors placeholder-gray-600"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>

                            <div>
                                <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Zona</label>
                                <select 
                                    className="w-full bg-black/50 border border-gray-700 rounded-lg p-2 text-sm text-gray-300 outline-none focus:border-brand-orange"
                                    value={selectedZone}
                                    onChange={(e) => setSelectedZone(e.target.value)}
                                >
                                    {ZONES.map(z => <option key={z} value={z}>{z}</option>)}
                                </select>
                            </div>

                            <div>
                                <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Institución</label>
                                <select 
                                    className="w-full bg-black/50 border border-gray-700 rounded-lg p-2 text-sm text-gray-300 outline-none focus:border-brand-orange"
                                    value={selectedUni}
                                    onChange={(e) => { setSelectedUni(e.target.value); setSelectedCareer("Todas"); }}
                                >
                                    <option value="Todas">Todas las Instituciones</option>
                                    {Object.keys(HUANCAYO_DATA).map(uni => (
                                        <option key={uni} value={uni}>{uni}</option>
                                    ))}
                                </select>
                            </div>

                            {selectedUni !== "Todas" && (
                                <div className="animate-fade-in">
                                    <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Carrera / Facultad</label>
                                    <select 
                                        className="w-full bg-black/50 border border-gray-700 rounded-lg p-2 text-sm text-gray-300 outline-none focus:border-brand-orange"
                                        value={selectedCareer}
                                        onChange={(e) => setSelectedCareer(e.target.value)}
                                    >
                                        <option value="Todas">Todas las carreras</option>
                                        {careersForSelectedUni.map(car => (
                                            <option key={car} value={car}>{car}</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                        </div>
                        
                        <button 
                            onClick={() => {setSelectedZone("Todos"); setSelectedUni("Todas"); setSelectedCareer("Todas"); setSearchTerm("");}}
                            className="w-full mt-4 py-2 text-xs text-gray-500 hover:text-brand-orange border border-dashed border-gray-700 hover:border-brand-orange rounded transition-all">
                            <i className="fas fa-eraser mr-1"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            );
        }

        const Modal = ({ isOpen, onClose, onSubmit }) => {
            const [preview, setPreview] = useState(null);
            const [compressedFile, setCompressedFile] = useState(null);
            const [institution, setInstitution] = useState("");
            const [career, setCareer] = useState("");
            const [customCareer, setCustomCareer] = useState("");
            const [isCustom, setIsCustom] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (!isOpen) {
                    setPreview(null);
                    setCompressedFile(null);
                    setInstitution("");
                    setCareer("");
                    setCustomCareer("");
                    setIsCustom(false);
                    setIsSubmitting(false);
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                const newFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(newFile);
                            }, 'image/jpeg', 0.7);
                        };
                    };
                });
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setPreview(URL.createObjectURL(file));
                    // Show preview immediately, compress in background
                    try {
                        const compressed = await compressImage(file);
                        setCompressedFile(compressed);
                    } catch (err) {
                        console.error("Compression failed", err);
                        setCompressedFile(file); // Fallback to original
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSubmitting) return;
                setIsSubmitting(true);

                const formData = new FormData(e.target);
                
                // Logic for "Profession" field combination
                let finalProfession = "";
                if (isCustom || institution === "Otro") {
                    finalProfession = customCareer;
                } else {
                    finalProfession = `${career} - ${institution}`;
                }
                
                // Override the form data for profession
                formData.set('profession', finalProfession);

                // Use compressed file if available
                if (compressedFile) {
                    formData.set('image', compressedFile);
                }

                await onSubmit(formData);
                setIsSubmitting(false);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="glass-panel w-full max-w-lg rounded-xl overflow-hidden shadow-2xl shadow-orange-900/20 max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gradient-to-r from-brand-orange/10 to-transparent">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <i className="fas fa-bullhorn text-brand-orange"></i> Nuevo Reporte
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white w-8 h-8 rounded-full hover:bg-gray-800 flex items-center justify-center transition-colors">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-5">
                            {/* Datos Personales */}
                            <div>
                                <label className="block text-xs font-bold text-brand-orange uppercase mb-1 ml-1">¿Quién es?</label>
                                <input name="targetName" type="text" placeholder="Nombre completo o Apodo conocido" className="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-brand-orange outline-none transition-all" required />
                            </div>
                            
                            {/* Selectores Inteligentes */}
                            <div className="bg-gray-900/50 p-4 rounded-lg border border-gray-800 space-y-3">
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Contexto Académico / Lugar</label>
                                
                                <select 
                                    className="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white focus:border-brand-orange outline-none"
                                    value={institution}
                                    onChange={(e) => {
                                        setInstitution(e.target.value);
                                        setCareer("");
                                        setIsCustom(e.target.value === "Institutos / Otros" || e.target.value === "Lugares Públicos / Otros");
                                    }}
                                    required
                                >
                                    <option value="" disabled>Selecciona Institución / Lugar</option>
                                    {Object.keys(HUANCAYO_DATA).map(k => <option key={k} value={k}>{k}</option>)}
                                    <option value="Otro">Otro (Escribir manual)</option>
                                </select>

                                {institution && institution !== "Otro" && !isCustom && (
                                    <select 
                                        className="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white focus:border-brand-orange outline-none"
                                        value={career}
                                        onChange={(e) => setCareer(e.target.value)}
                                        required
                                    >
                                        <option value="" disabled>Selecciona Carrera / Detalle</option>
                                        {HUANCAYO_DATA[institution].map(c => <option key={c} value={c}>{c}</option>)}
                                        <option value="Otro">Otro (Escribir manual)</option>
                                    </select>
                                )}

                                {(institution === "Otro" || career === "Otro" || isCustom) && (
                                    <input 
                                        type="text" 
                                        placeholder="Escribe manualmente (Ej. Instituto X - Enfermería)" 
                                        className="w-full bg-brand-dark border border-brand-orange/50 rounded p-2 text-sm text-white focus:border-brand-orange outline-none animate-fade-in"
                                        value={customCareer}
                                        onChange={(e) => setCustomCareer(e.target.value)}
                                        required
                                    />
                                )}
                            </div>

                            {/* Ubicación y Zona */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">¿Dónde fue?</label>
                                <input name="location" type="text" placeholder="Ej. Real Plaza, 2do piso" className="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-brand-orange outline-none" required />
                            </div>

                            {/* Descripción */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">El Chisme Detallado</label>
                                <textarea name="description" required rows="4" placeholder="Cuenta todo con lujo de detalles..." className="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-brand-orange outline-none resize-none"></textarea>
                            </div>

                            {/* Subida de Imagen */}
                            <div className="border-2 border-dashed border-gray-700 rounded-lg h-40 relative overflow-hidden group hover:border-brand-orange hover:bg-brand-orange/5 transition-all">
                                <input type="file" name="image" onChange={handleFileChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*" />
                                
                                {preview ? (
                                    <img src={preview} alt="Previsualización" className="w-full h-full object-cover" />
                                ) : (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 group-hover:text-brand-orange transition-colors">
                                        <i className="fas fa-camera text-3xl mb-2"></i>
                                        <p className="text-xs font-bold uppercase">Subir Evidencia</p>
                                    </div>
                                )}
                            </div>

                            <div className="text-[10px] text-gray-500 text-center px-4">
                                Tu IP es anónima. Al publicar aceptas que esto es humor/sátira.
                            </div>

                            <button 
                                type="submit" 
                                disabled={isSubmitting}
                                className={`w-full font-extrabold py-4 rounded-lg transition-all shadow-lg ${isSubmitting ? 'bg-gray-600 text-gray-300 cursor-not-allowed' : 'bg-brand-orange text-black hover:bg-orange-500 hover:scale-[1.02] shadow-orange-500/20'}`}
                            >
                                {isSubmitting ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <i className="fas fa-circle-notch fa-spin"></i> PUBLICANDO...
                                    </span>
                                ) : (
                                    "PUBLICAR AHORA"
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const DisclaimerBanner = ({ onClose }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-brand-orange text-black p-4 z-50 flex justify-between items-center flex-wrap gap-4 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] border-t-4 border-black">
                <div className="text-xs sm:text-sm font-bold max-w-4xl flex items-center gap-3">
                    <i className="fas fa-skull-crossbones text-2xl"></i>
                    <div>
                        <p>ADVERTENCIA: CONTENIDO DE ALTO VOLTAJE</p>
                        <p className="font-normal opacity-80">Esta plataforma es satírica. "HuancaLeaks" no se hace responsable de corazones rotos o relaciones terminadas.</p>
                    </div>
                </div>
                <button onClick={onClose} className="bg-black text-white px-6 py-2 rounded-full text-xs hover:bg-gray-800 font-bold uppercase tracking-wide transition-colors">
                    Entendido, dame chisme
                </button>
            </div>
        );

        // --- APP PRINCIPAL ---

        const App = () => {
            const [posts, setPosts] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showDisclaimer, setShowDisclaimer] = useState(true);
            const [loading, setLoading] = useState(true);
            
            // Estados de Filtro
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedZone, setSelectedZone] = useState("Todos");
            const [selectedUni, setSelectedUni] = useState("Todas");
            const [selectedCareer, setSelectedCareer] = useState("Todas");

            useEffect(() => {
                fetchPosts();
            }, []);

            const fetchPosts = async () => {
                try {
                    const response = await fetch(`${API_URL}/posts`);
                    const data = await response.json();
                    
                    const mappedPosts = data.map(p => ({
                        id: p.id,
                        name: p.name,
                        targetName: p.target_name,
                        profession: p.profession,
                        location: p.location,
                        description: p.description,
                        date: new Date(p.date).toLocaleString(),
                        likes: p.likes,
                        image: p.image_url ? (p.image_url.startsWith('http') ? p.image_url : p.image_url) : null
                    }));
                    setPosts(mappedPosts);
                    setLoading(false);
                } catch (error) {
                    console.error("Error fetching posts:", error);
                    setLoading(false);
                }
            };

            const handleNewPost = async (formData) => {
                try {
                    const response = await fetch(`${API_URL}/posts`, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.ok) {
                        fetchPosts(); 
                        setIsModalOpen(false);
                    } else {
                        alert("Error al publicar. Verifica tu conexión.");
                    }
                } catch (error) {
                    console.error("Error posting:", error);
                }
            };

            // Lógica de Filtrado Avanzada
            const filteredPosts = useMemo(() => {
                return posts.filter(post => {
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = (post.targetName || "").toLowerCase().includes(search) || 
                                          (post.description || "").toLowerCase().includes(search) ||
                                          (post.profession || "").toLowerCase().includes(search);
                    
                    const matchesZone = selectedZone === "Todos" || (post.location || "").includes(selectedZone);
                    
                    // Filtro de Institución y Carrera (Matching parcial porque "Profesión" guarda ambas)
                    let matchesUni = true;
                    if (selectedUni !== "Todas") {
                        matchesUni = (post.profession || "").includes(selectedUni) || 
                                     (HUANCAYO_DATA[selectedUni] && HUANCAYO_DATA[selectedUni].some(c => (post.profession || "").includes(c)));
                    }

                    let matchesCareer = true;
                    if (selectedCareer !== "Todas") {
                        matchesCareer = (post.profession || "").includes(selectedCareer);
                    }

                    return matchesSearch && matchesZone && matchesUni && matchesCareer;
                });
            }, [posts, searchTerm, selectedZone, selectedUni, selectedCareer]);

            return (
                <div className="min-h-screen pb-10 font-sans selection:bg-brand-orange selection:text-black">
                    <Header onOpenModal={() => setIsModalOpen(true)} />

                    <main className="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        {/* Columna Izquierda (Feed) */}
                        <div className="lg:col-span-2">
                            <div className="mb-6 flex items-center justify-between glass-panel p-4 rounded-lg">
                                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                    <span className="w-2 h-8 bg-brand-orange rounded-full block"></span>
                                    Feed de Reportes
                                </h2>
                                <span className="text-xs font-mono text-brand-orange bg-brand-orange/10 px-2 py-1 rounded border border-brand-orange/20">
                                    {filteredPosts.length} BOMBAS
                                </span>
                            </div>

                            {loading ? (
                                <div className="text-center py-20">
                                    <div className="inline-block w-12 h-12 border-4 border-brand-orange border-t-transparent rounded-full animate-spin"></div>
                                    <p className="mt-4 text-gray-500 text-sm animate-pulse">Recuperando chismes encriptados...</p>
                                </div>
                            ) : filteredPosts.length > 0 ? (
                                filteredPosts.map(post => (
                                    <ReportCard key={post.id} report={post} />
                                ))
                            ) : (
                                <div className="text-center py-20 glass-panel rounded-xl border border-dashed border-gray-700">
                                    <i className="fas fa-wind text-5xl text-gray-700 mb-4"></i>
                                    <p className="text-gray-400 font-bold">Nada por aquí...</p>
                                    <p className="text-gray-600 text-sm mb-4">Nadie ha quemado a nadie con esos filtros.</p>
                                    <button 
                                        className="text-brand-orange text-xs font-bold hover:underline uppercase" 
                                        onClick={() => {setSelectedZone("Todos"); setSelectedUni("Todas"); setSearchTerm("");}}
                                    >
                                        Ver todo el chisme
                                    </button>
                                </div>
                            )}
                            
                            {!loading && filteredPosts.length > 0 && (
                                <div className="text-center py-8">
                                    <p className="text-gray-600 text-xs uppercase tracking-widest">Fin de los reportes</p>
                                    <i className="fas fa-circle text-[4px] text-gray-800 mt-2"></i>
                                </div>
                            )}
                        </div>

                        {/* Columna Derecha (Sidebar) */}
                        <div className="hidden lg:block">
                            <Sidebar 
                                selectedZone={selectedZone} 
                                setSelectedZone={setSelectedZone}
                                selectedUni={selectedUni}
                                setSelectedUni={setSelectedUni}
                                selectedCareer={selectedCareer}
                                setSelectedCareer={setSelectedCareer}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                            />
                        </div>
                    </main>

                    {/* Botón flotante para móviles (Filtros) */}
                    <div className="lg:hidden fixed bottom-6 right-6 z-40 group">
                        <button 
                             onClick={() => window.scrollTo({top: 0, behavior: 'smooth'})}
                            className="bg-brand-gray border border-brand-orange text-brand-orange p-4 rounded-full shadow-2xl shadow-black active:scale-90 transition-transform"
                        >
                            <i className="fas fa-arrow-up"></i>
                        </button>
                    </div>

                    <Modal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSubmit={handleNewPost} 
                    />

                    {showDisclaimer && <DisclaimerBanner onClose={() => setShowDisclaimer(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>